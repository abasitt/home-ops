---
controllers:
  photoprism:
    type: statefulset
    strategy: RollingUpdate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: docker.io/photoprism/photoprism
          tag: latest@sha256:5db91badeec3f1e32a624f9e6c70541fe5d28ddfd5447d5d258046a5768c1c0b
        env:
          PHOTOPRISM_STORAGE_PATH: &storage /config
          PHOTOPRISM_ORIGINALS_PATH: &originals /originals
          PHOTOPRISM_DEBUG: "true"
          PHOTOPRISM_PUBLIC: "false"
          PHOTOPRISM_SITE_URL: "https://photos.${SECRET_DOMAIN}/"
          PHOTOPRISM_ORIGINALS_LIMIT: 4000 # in MB (default 1000)
        envFrom:
          - secretRef:
              name: photoprism-secret
              optional: false
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1
            memory: 1Gi
defaultPodOptions:
  securityContext:
    runAsNonRoot: true
    runAsUser: 2000
    runAsGroup: 2000
    fsGroup: 2000
    fsGroupChangePolicy: OnRootMismatch
    seccompProfile: { type: RuntimeDefault }
service:
  app:
    controller: photoprism
    ports:
      http:
        port: 2342
route:
  app:
    parentRefs:
      - group: ""
        kind: Gateway
        name: external-gateway
        namespace: istio-gateways
    hostnames:
      - photos.${SECRET_DOMAIN}
    rules:
      - matches:
          - path:
              type: PathPrefix
              value: /
        backendRefs:
          - kind: Service
            port: http
            name: app
            weight: 100
persistence:
  config:
    enabled: true
    existingClaim: ${VOLSYNC_CLAIM}
    globalMounts:
      - path: *storage
  originals:
    existingClaim: media-nfs
    globalMounts:
      - path: *originals
        subPath: /photos/abasit
